# Template for running drug-disease gene expression profile similarity analysis
# From Butte et. al., Sci Transl Med 2011

```{r start time, echo=FALSE}
begin.time <- Sys.time()
```

## Initialization

Load required packages and source necessary functions.

```{r initialize, echo=TRUE}
library("GEOquery") # For pulling data from GEO
library("siggenes") # For running SAM analysis
library("affyPLM") # For rank normalization of ExpressionSets
library("cMap2data") # For drug signature ranked lists
source("butte_helper.R") # Helper functions for analysis
data(drugRL) # Load the drug ranked list data from cMap
```

We get the list of up- and down-regulated genes via limma analysis of each specified dataset.

```{r get gene lists, echo=TRUE}
glist <- list()
for(i in 1:length(ids)){
	glist[[i]] <- get_gene_list(ids[i])
}
names(glist) <- ids
```

We now know which genes are up- and down-regulated, and rank them by fold change in expression.
Using this ranking, we compare each disease signature to each drug signature. We also calculate
a p-value and FDR for the observed drug disease score.

```{r calculate dds, echo=TRUE}
ddsmat <- pvals <- qvals <- matrix(0,ndrug,length(glist),dimnames=c(colnames(drugRL)[1:ndrug],names(glist))

for(i in 1:ndrug){
	for(j in 1:length(glist)){
		ddsmat[i,j] <- calc_dds(drugRL[,i],glist[[j]])
		pvals[i,j] <- calc_pval(glist[[j]],rownames(drugRL),ddsmat[i,j])
	}
	# Get FDR for each pval
	qvals[,i] <- qvalue(pvals[,i], lambda=0) #B-H correction, for safety
}
```

## Present output

```{r output, echo=TRUE}
heatmap(ddsmat)
```

## R session information

```{r session info}
sessionInfo()
```

SHA-1 hashes for the input data file and the original data frame.

```{r hash information, echo=FALSE}
cat(sprintf("%s: %s\n", sQuote(datafile), hashfile))
cat(sprintf("data frame: %s\n", hashdframe))
```


This analysis started on `r format(begin.time)` and was completed on
`r format(Sys.time())`.